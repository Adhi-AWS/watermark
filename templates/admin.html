<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .activity-log {
            max-height: 600px;
            overflow-y: auto;
        }
        .log-entry {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .log-entry.file-opened {
            border-left-color: #28a745;
        }
        .log-entry.print-action {
            border-left-color: #ffc107;
        }
        .log-entry.security-event {
            border-left-color: #dc3545;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>üìä Activity Monitoring Dashboard</h1>
                    <button class="btn btn-primary" onclick="refreshLogs()">üîÑ Refresh</button>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="total-sessions">0</h3>
                        <p class="mb-0">Total Sessions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 id="file-opens">0</h3>
                        <p class="mb-0">Files Opened</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3 id="print-requests">0</h3>
                        <p class="mb-0">Print Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h3 id="security-events">0</h3>
                        <p class="mb-0">Security Events</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-select" id="activity-filter">
                    <option value="">All Activities</option>
                    <option value="FILE_OPENED">File Opened</option>
                    <option value="PRINT">Print Actions</option>
                    <option value="BLOCKED">Security Events</option>
                    <option value="SCROLL">User Interactions</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="session-filter" placeholder="Filter by Session ID">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="file-filter" placeholder="Filter by Filename">
            </div>
        </div>
        
        <!-- Activity Logs -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üîç Real-time Activity Log</h5>
                    </div>
                    <div class="card-body activity-log" id="activity-container">
                        {% for log in logs|reverse %}
                        <div class="log-entry {% if 'OPENED' in log.activity %}file-opened{% elif 'PRINT' in log.activity %}print-action{% elif 'BLOCKED' in log.activity or 'ATTEMPT' in log.activity %}security-event{% endif %}" 
                             data-activity="{{ log.activity }}" 
                             data-session="{{ log.session_id }}" 
                             data-file="{{ log.file_name }}">
                            <div class="d-flex justify-content-between">
                                <strong>{{ log.activity }}</strong>
                                <small class="text-muted">{{ log.timestamp }}</small>
                            </div>
                            <div class="mt-1">
                                <strong>File:</strong> {{ log.file_name }} | 
                                <strong>Session:</strong> {{ log.session_id[:8] }}... | 
                                <strong>IP:</strong> {{ log.ip_address }}
                            </div>
                            {% if log.additional_info %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    {% for key, value in log.additional_info.items() %}
                                        <strong>{{ key }}:</strong> {{ value }}{% if not loop.last %} | {% endif %}
                                    {% endfor %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh logs every 5 seconds
        setInterval(refreshLogs, 5000);
        
        function refreshLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(logs => {
                    updateStatistics(logs);
                    updateLogEntries(logs);
                })
                .catch(error => console.error('Error fetching logs:', error));
        }
        
        function updateStatistics(logs) {
            const uniqueSessions = [...new Set(logs.map(log => log.session_id))].length;
            const fileOpens = logs.filter(log => log.activity === 'FILE_OPENED').length;
            const printRequests = logs.filter(log => log.activity.includes('PRINT')).length;
            const securityEvents = logs.filter(log => 
                log.activity.includes('BLOCKED') || log.activity.includes('ATTEMPT')
            ).length;
            
            document.getElementById('total-sessions').textContent = uniqueSessions;
            document.getElementById('file-opens').textContent = fileOpens;
            document.getElementById('print-requests').textContent = printRequests;
            document.getElementById('security-events').textContent = securityEvents;
        }
        
        function updateLogEntries(logs) {
            const container = document.getElementById('activity-container');
            const reversedLogs = logs.reverse();
            
            let html = '';
            reversedLogs.forEach(log => {
                let cssClass = '';
                if (log.activity.includes('OPENED')) cssClass = 'file-opened';
                else if (log.activity.includes('PRINT')) cssClass = 'print-action';
                else if (log.activity.includes('BLOCKED') || log.activity.includes('ATTEMPT')) cssClass = 'security-event';
                
                html += `
                    <div class="log-entry ${cssClass}" 
                         data-activity="${log.activity}" 
                         data-session="${log.session_id}" 
                         data-file="${log.file_name}">
                        <div class="d-flex justify-content-between">
                            <strong>${log.activity}</strong>
                            <small class="text-muted">${log.timestamp}</small>
                        </div>
                        <div class="mt-1">
                            <strong>File:</strong> ${log.file_name} | 
                            <strong>Session:</strong> ${log.session_id.substring(0, 8)}... | 
                            <strong>IP:</strong> ${log.ip_address}
                        </div>
                `;
                
                if (log.additional_info && Object.keys(log.additional_info).length > 0) {
                    html += '<div class="mt-1"><small class="text-muted">';
                    Object.entries(log.additional_info).forEach(([key, value], index, array) => {
                        html += `<strong>${key}:</strong> ${value}`;
                        if (index < array.length - 1) html += ' | ';
                    });
                    html += '</small></div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        // Filter functionality
        document.getElementById('activity-filter').addEventListener('change', applyFilters);
        document.getElementById('session-filter').addEventListener('input', applyFilters);
        document.getElementById('file-filter').addEventListener('input', applyFilters);
        
        function applyFilters() {
            const activityFilter = document.getElementById('activity-filter').value;
            const sessionFilter = document.getElementById('session-filter').value.toLowerCase();
            const fileFilter = document.getElementById('file-filter').value.toLowerCase();
            
            const logEntries = document.querySelectorAll('.log-entry');
            
            logEntries.forEach(entry => {
                const activity = entry.dataset.activity;
                const session = entry.dataset.session.toLowerCase();
                const file = entry.dataset.file.toLowerCase();
                
                let show = true;
                
                if (activityFilter && !activity.includes(activityFilter)) show = false;
                if (sessionFilter && !session.includes(sessionFilter)) show = false;
                if (fileFilter && !file.includes(fileFilter)) show = false;
                
                entry.style.display = show ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>
